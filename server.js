const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const cors = require('cors');
const path = require('path');
const fs = require('fs');
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const app = express();
const server = http.createServer(app);

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ environment variables
console.log('ğŸ”§ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° environment variables...');
console.log('SUPABASE_URL:', process.env.SUPABASE_URL ? 'âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½' : 'âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚');
console.log('SUPABASE_SERVICE_KEY:', process.env.SUPABASE_SERVICE_KEY ? 'âœ… Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½' : 'âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚');

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
if (!process.env.SUPABASE_URL || !process.env.SUPABASE_SERVICE_KEY) {
  console.error('âŒ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ: ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Supabase environment variables');
  console.error('ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ:');
  console.error('SUPABASE_URL=Ğ²Ğ°Ñˆ_supabase_url');
  console.error('SUPABASE_SERVICE_KEY=Ğ²Ğ°Ñˆ_service_key');
  process.exit(1);
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Supabase Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹
let supabase;
try {
  supabase = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY
  );
  console.log('âœ… Supabase Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
} catch (error) {
  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Supabase:', error.message);
  process.exit(1);
}

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° CORS
const io = socketIo(server, {
  cors: {
    origin: ["http://spokoyniyrassvet.webtm.ru", "https://spokoyniyrassvet.webtm.ru"],
    methods: ["GET", "POST"],
    credentials: true
  },
  transports: ['websocket', 'polling']
});

// Middleware
app.use(cors({
  origin: ["http://spokoyniyrassvet.webtm.ru", "https://spokoyniyrassvet.webtm.ru"],
  credentials: true
}));
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ°Ğ¿Ğ¾Ğº
const createDirectories = () => {
  const folders = [
    './frontend/media/avatars',
    './frontend/media/uploads', 
    './frontend/media/stickers',
    './frontend/images'
  ];
  
  folders.forEach(folder => {
    try {
      if (fs.existsSync(folder)) {
        const stats = fs.statSync(folder);
        if (!stats.isDirectory()) {
          console.warn(`âš ï¸  ${folder} ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ ĞºĞ°Ğº Ñ„Ğ°Ğ¹Ğ», Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼...`);
          const backupPath = `${folder}.backup_${Date.now()}`;
          fs.renameSync(folder, backupPath);
          console.log(`âœ… Ğ¤Ğ°Ğ¹Ğ» Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½ Ğ²: ${backupPath}`);
        }
      }
      
      if (!fs.existsSync(folder)) {
        fs.mkdirSync(folder, { recursive: true });
        console.log(`âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¿Ğ°Ğ¿ĞºĞ°: ${folder}`);
      }
    } catch (error) {
      console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ°Ğ¿ĞºĞ¸ ${folder}:`, error.message);
    }
  });
};

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºĞ¸
createDirectories();

// Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
app.use(express.static(path.join(__dirname, 'frontend')));
app.use('/css', express.static(path.join(__dirname, 'frontend', 'css')));
app.use('/js', express.static(path.join(__dirname, 'frontend', 'js')));
app.use('/images', express.static(path.join(__dirname, 'frontend', 'images')));
app.use('/media', express.static(path.join(__dirname, 'frontend', 'media')));

// Middleware Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
app.use((req, res, next) => {
  console.log(`ğŸ“¨ ${req.method} ${req.path} - ${new Date().toISOString()}`);
  next();
});

// Middleware Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
const authenticateToken = async (req, res, next) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({ error: 'Ğ¢Ğ¾ĞºĞµĞ½ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½' });
    }

    // Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ñƒ (Ğ² Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ»ÑƒÑ‡Ğ°Ğµ Ñ‚Ğ¾ĞºĞµĞ½ - ÑÑ‚Ğ¾ user ID)
    const { data: user, error } = await supabase
      .from('users')
      .select('*')
      .eq('id', token)
      .single();

    if (error || !user) {
      return res.status(401).json({ error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½' });
    }

    if (user.is_blocked) {
      return res.status(403).json({ error: 'ĞĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½' });
    }

    req.user = user;
    next();
  } catch (error) {
    console.error('Auth error:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸' });
  }
};

// Middleware Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ñ€Ğ¾Ğ»ĞµĞ¹
const requireRole = (roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½' });
    }

    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: 'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ²' });
    }

    next();
  };
};

// API Routes
// ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ
app.post('/auth/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    if (!username || !password) {
      return res.status(400).json({ error: 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ' });
    }

    // Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ username Ğ¸Ğ»Ğ¸ telegram_username
    const { data: user, error } = await supabase
      .from('users')
      .select('*')
      .or(`username.eq.${username},telegram_username.eq.${username}`)
      .single();

    if (error || !user) {
      return res.status(401).json({ error: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½' });
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ (Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ bcrypt)
    if (user.password_hash !== password) {
      return res.status(401).json({ error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ' });
    }

    if (user.is_blocked) {
      return res.status(403).json({ error: 'ĞĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½' });
    }

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½
    await supabase
      .from('users')
      .update({ is_online: true, updated_at: new Date().toISOString() })
      .eq('id', user.id);

    // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ñ…Ğ¾Ğ´
    await supabase
      .from('system_logs')
      .insert([
        {
          user_id: user.id,
          action: 'user_login',
          details: { method: 'username_password', username: username },
          ip_address: req.ip
        }
      ]);

    res.json({
      success: true,
      token: user.id, // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ID ĞºĞ°Ğº Ñ‚Ğ¾ĞºĞµĞ½
      user: {
        id: user.id,
        username: user.username,
        telegram_username: user.telegram_username,
        role: user.role,
        avatar_url: user.avatar_url,
        theme: user.theme
      }
    });

  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°' });
  }
});

app.post('/auth/register', async (req, res) => {
  try {
    const { username, telegram_username, password, confirmPassword } = req.body;

    // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
    if (!username || username.length < 2) {
      return res.status(400).json({ error: 'Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°' });
    }

    if (!telegram_username || !telegram_username.startsWith('@')) {
      return res.status(400).json({ error: 'Telegram username Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ‚ÑŒÑÑ Ñ @' });
    }

    if (password.length < 6) {
      return res.status(400).json({ error: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²' });
    }

    if (password !== confirmPassword) {
      return res.status(400).json({ error: 'ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚' });
    }

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const { data: existingUsers, error: checkError } = await supabase
      .from('users')
      .select('username, telegram_username')
      .or(`username.eq.${username},telegram_username.eq.${telegram_username}`);

    if (checkError) {
      throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ');
    }

    if (existingUsers && existingUsers.length > 0) {
      const existing = existingUsers[0];
      if (existing.username === username) {
        return res.status(400).json({ error: 'Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾' });
      }
      if (existing.telegram_username === telegram_username) {
        return res.status(400).json({ error: 'Telegram username ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ' });
      }
    }

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const { data: newUser, error: createError } = await supabase
      .from('users')
      .insert([
        {
          username: username,
          telegram_username: telegram_username,
          password_hash: password, // Ğ’ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğµ: await bcrypt.hash(password, 10)
          role: 'user',
          theme: 'light',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }
      ])
      .select()
      .single();

    if (createError) {
      throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: ' + createError.message);
    }

    // Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
    await supabase
      .from('system_logs')
      .insert([
        {
          user_id: newUser.id,
          action: 'user_registration',
          details: { username: username, telegram_username: telegram_username },
          ip_address: req.ip
        }
      ]);

    res.json({
      success: true,
      message: 'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°! Ğ’Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸.',
      user: {
        id: newUser.id,
        username: newUser.username,
        telegram_username: newUser.telegram_username,
        role: newUser.role
      }
    });

  } catch (error) {
    console.error('Register error:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸: ' + error.message });
  }
});

app.post('/auth/forgot-password', async (req, res) => {
  try {
    const { telegram_username } = req.body;

    if (!telegram_username || !telegram_username.startsWith('@')) {
      return res.status(400).json({ error: 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Telegram username' });
    }

    // Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Telegram
    const { data: user, error } = await supabase
      .from('users')
      .select('id, username, telegram_username')
      .eq('telegram_username', telegram_username)
      .single();

    if (error || !user) {
      return res.status(404).json({ error: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ñ‚Ğ°ĞºĞ¸Ğ¼ Telegram Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½' });
    }

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
    await supabase
      .from('notifications')
      .insert([
        {
          user_id: user.id,
          title: 'Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ',
          message: 'Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½. ĞĞ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² Telegram.',
          notification_type: 'info'
        }
      ]);

    res.json({
      success: true,
      message: 'ĞĞ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ, Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ½Ñ Ğ²Ğ°Ğ¼ Ğ½Ğ°Ğ¿Ğ¸ÑˆÑƒÑ‚ Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Telegram Ñ Ğ²Ğ°ÑˆĞ¸Ğ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼'
    });

  } catch (error) {
    console.error('Forgot password error:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ' });
  }
});

app.get('/auth/verify', authenticateToken, (req, res) => {
  res.json({
    success: true,
    user: {
      id: req.user.id,
      username: req.user.username,
      telegram_username: req.user.telegram_username,
      role: req.user.role,
      avatar_url: req.user.avatar_url,
      theme: req.user.theme
    }
  });
});

// ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
app.get('/user/profile', authenticateToken, (req, res) => {
  res.json({
    success: true,
    user: req.user
  });
});

app.put('/user/profile', authenticateToken, async (req, res) => {
  try {
    const { username, theme } = req.body;
    
    const { data: updatedUser, error } = await supabase
      .from('users')
      .update({
        username: username,
        theme: theme,
        updated_at: new Date().toISOString()
      })
      .eq('id', req.user.id)
      .select()
      .single();

    if (error) throw error;

    res.json({
      success: true,
      user: updatedUser
    });

  } catch (error) {
    console.error('Profile update error:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ' });
  }
});

// ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€)
app.get('/admin/users', authenticateToken, requireRole(['admin', 'coowner', 'owner']), async (req, res) => {
  try {
    const { data: users, error } = await supabase
      .from('users')
      .select('id, username, telegram_username, role, is_online, is_blocked, created_at')
      .order('created_at', { ascending: false });

    if (error) throw error;

    res.json({
      success: true,
      users: users
    });

  } catch (error) {
    console.error('Admin users error:', error);
    res.status(500).json({ error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹' });
  }
});

// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'frontend', 'index.html'));
});

// HTML ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
const servePage = (page, ...middlewares) => {
  app.get(`/${page}`, ...middlewares, (req, res) => {
    try {
      res.sendFile(path.join(__dirname, 'frontend', page));
    } catch (error) {
      console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ${page}:`, error);
      res.status(500).send('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹');
    }
  });
};

// Ğ—Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
servePage('chat.html', authenticateToken);
servePage('admin.html', authenticateToken, requireRole(['admin', 'coowner', 'owner']));
servePage('owner.html', authenticateToken, requireRole(['owner']));
servePage('coowner.html', authenticateToken, requireRole(['coowner', 'owner']));
servePage('listener.html', authenticateToken, requireRole(['listener', 'admin', 'coowner', 'owner']));
servePage('settings.html', authenticateToken);

// Health check
app.get('/health', async (req, res) => {
  try {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Supabase
    const { data, error } = await supabase
      .from('users')
      .select('count')
      .limit(1);

    res.json({ 
      status: 'OK', 
      timestamp: new Date().toISOString(),
      database: error ? 'ERROR' : 'CONNECTED',
      version: '2.0.0'
    });
  } catch (error) {
    res.json({ 
      status: 'ERROR', 
      timestamp: new Date().toISOString(),
      database: 'ERROR',
      error: error.message
    });
  }
});

// WebSocket Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
io.on('connection', (socket) => {
  console.log('ğŸ”Œ ĞĞ¾Ğ²Ğ¾Ğµ WebSocket Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ:', socket.id);
  
  socket.on('authenticate', async (token) => {
    try {
      const { data: user, error } = await supabase
        .from('users')
        .select('*')
        .eq('id', token)
        .single();

      if (error || !user) {
        socket.emit('auth_error', { error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½' });
        return;
      }

      socket.userId = user.id;
      socket.user = user;
      
      // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½
      await supabase
        .from('users')
        .update({ is_online: true })
        .eq('id', user.id);

      socket.emit('authenticated', {
        user: {
          id: user.id,
          username: user.username,
          telegram_username: user.telegram_username,
          role: user.role,
          avatar_url: user.avatar_url
        }
      });

      console.log(`âœ… ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ${user.username} Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñ‡ĞµÑ€ĞµĞ· WebSocket`);

    } catch (error) {
      console.error('WebSocket auth error:', error);
      socket.emit('auth_error', { error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸' });
    }
  });
  
  socket.on('send_message', async (data) => {
    try {
      if (!socket.userId) {
        socket.emit('error', { error: 'ĞĞµ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½' });
        return;
      }

      const { data: message, error } = await supabase
        .from('messages')
        .insert([
          {
            chat_id: data.chat_id,
            sender_id: socket.userId,
            content: data.content,
            message_type: data.message_type || 'text',
            media_url: data.media_url,
            sticker_url: data.sticker_url,
            created_at: new Date().toISOString()
          }
        ])
        .select(`
          *,
          sender:users(id, username, telegram_username, avatar_url, role)
        `)
        .single();

      if (error) throw error;

      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ¼ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°Ğ¼ Ñ‡Ğ°Ñ‚Ğ°
      socket.to(data.chat_id).emit('new_message', message);
      socket.emit('message_sent', message);

    } catch (error) {
      console.error('Send message error:', error);
      socket.emit('error', { error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ' });
    }
  });
  
  socket.on('disconnect', async () => {
    console.log('ğŸ”Œ WebSocket Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ:', socket.id);
    
    if (socket.userId) {
      // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½
      await supabase
        .from('users')
        .update({ is_online: false })
        .eq('id', socket.userId);
    }
  });
});

const PORT = process.env.PORT || 10000;
server.listen(PORT, '0.0.0.0', () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
  console.log(`ğŸ“ Working directory: ${__dirname}`);
  console.log(`ğŸŒ DOMAIN: spokoyniyrassvet.webtm.ru`);
  console.log(`ğŸ”§ Environment: ${process.env.NODE_ENV || 'production'}`);
  console.log(`ğŸ“Š Supabase: CONFIGURED`);
  console.log(`âœ… SERVER READY - Telegram auth system operational!`);
});
