<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –°–∏—Å—Ç–µ–º–∞ - –û–±—â–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/light-theme.css" id="theme-style">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="container">
                <h1 class="logo">üí¨ –ß–∞—Ç</h1>
                <div class="header-actions">
                    <span id="userWelcome">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <button class="btn btn-outline" onclick="openSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="btn btn-outline" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </header>

        <main class="chat-container">
            <aside class="chat-sidebar">
                <div class="sidebar-section">
                    <h3>–ú–æ–π —á–∞—Ç</h3>
                    <div class="chat-info">
                        <p>–°—Ç–∞—Ç—É—Å: <span class="status-online">‚óè –æ–Ω–ª–∞–π–Ω</span></p>
                        <button class="btn btn-primary btn-full" onclick="startChat()">–ù–∞—á–∞—Ç—å —á–∞—Ç</button>
                    </div>
                </div>
            </aside>

            <div class="chat-main">
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-message">
                        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!</h2>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å —á–∞—Ç"</p>
                    </div>
                </div>

                <div class="message-input-container">
                    <form class="message-input-form" id="messageForm">
                        <input type="text" id="messageInput" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                        <button type="submit" class="btn btn-primary" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </main>

        <div id="message" class="message"></div>
    </div>

    <script>
        class ChatManager {
            constructor() {
                this.currentUser = null;
                this.init();
            }

            async init() {
                await this.checkAuth();
                this.setupEventListeners();
                this.loadUserData();
            }

            async checkAuth() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');

                if (!token || !user) {
                    window.location.href = '/';
                    return;
                }

                try {
                    const response = await fetch('/auth/verify', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('Not authenticated');
                    }

                    const data = await response.json();
                    this.currentUser = data.user;
                } catch (error) {
                    this.logout();
                }
            }

            setupEventListeners() {
                document.getElementById('messageForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });
            }

            loadUserData() {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                document.getElementById('userWelcome').textContent = user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }

            async startChat() {
                try {
                    const response = await fetch('/chat/create', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.enableChat();
                        this.showMessage('–ß–∞—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
                    }
                } catch (error) {
                    this.showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞', 'error');
                }
            }

            enableChat() {
                document.getElementById('messageInput').disabled = false;
                document.querySelector('button[type="submit"]').disabled = false;
                document.querySelector('.welcome-message').style.display = 'none';
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();

                if (!content) return;

                try {
                    const response = await fetch('/chat/message', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            chatId: 'test-chat',
                            content: content
                        })
                    });

                    if (response.ok) {
                        input.value = '';
                        this.addMessage(content, true);
                    }
                } catch (error) {
                    this.showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
                }
            }

            addMessage(content, isOwn = false) {
                const container = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-item ${isOwn ? 'own' : 'other'}`;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${isOwn ? '–í—ã' : '–°–ª—É—à–∞—Ç–µ–ª—å'}</span>
                        <span class="message-time">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-text">${content}</div>
                `;
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }

            showMessage(text, type) {
                const messageEl = document.getElementById('message');
                messageEl.textContent = text;
                messageEl.className = `message ${type}`;
                setTimeout(() => messageEl.textContent = '', 5000);
            }

            logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function openSettings() {
            window.location.href = '/settings.html';
        }

        function logout() {
            chatManager.logout();
        }

        function startChat() {
            chatManager.startChat();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const chatManager = new ChatManager();
    </script>
</body>
</html>
